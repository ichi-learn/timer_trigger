### Azure操作に関する再発防止策と作業手順書

#### 1. 基本原則

何よりも優先されるべき3つの基本原則を定める。

*   **原則1: 推測の禁止、事実の確認 (Verify, Don't Assume)**
    *   リソースグループ名、アプリケーション名、ホスト名などの環境に依存する情報は、決して推測しない。必ずAzure CLIコマンドを実行し、Azureから返却された**事実**に基づいて作業を行う。

*   **原則2: 非同期処理の理解と待機 (Respect Asynchronous Operations)**
    *   デプロイ (`deployment`) のような非同期コマンドは、成功応答が返っても即座に完了しているわけではないことを理解する。次のアクションに移る前に、必ずリソースの状態が目的の状態（例: "Running"）に達したことを確認するステップを挟む。

*   **原則3: 段階的な検証 (Incremental Verification)**
    *   一度に全ての工程を試すのではなく、「デプロイが完了したか」「アプリが起動したか」「ネットワーク的に到達可能か」「APIが正しく応答するか」のように、検証可能な最小単位で作業を分割し、一つずつ確認しながら進める。

---

#### 2. 具体的な作業手順

Azure Function Appのデプロイから動作確認までを、以下のフェーズに分けて実行する。

**【フェーズ1: 必須情報の収集・計画】**
1.  **リソースグループの特定:** `az group list --query "[].name" -o tsv` を実行し、利用可能なリソースグループの一覧から、対象となるものを特定する。
2.  **アプリケーションの特定:** 特定したリソースグループ名を使い、`az functionapp list -g <resource_group_name> --query "[].name" -o tsv` を実行し、操作対象のFunction App名を正確に特定する。
3.  **ホスト名の取得:** `az functionapp show -g <resource_group_name> -n <app_name> --query "defaultHostName" -o tsv` を実行し、正しいホスト名（URLのベース部分）を事前に取得する。

**【フェーズ2: デプロイ実行】**
1.  **デプロイコマンドの実行:** フェーズ1で取得した**正確なリソースグループ名とApp名**を使用して、`az functionapp deployment source config-zip` コマンドを実行する。

**【フェーズ3: 起動の確認】**
1.  **状態のポーリング:** デプロイコマンド実行後、**即座に次の作業に移らない**。`az functionapp show -g <resource_group_name> -n <app_name> --query "state"` を定期的に実行し、応答が `"Running"` になることを確認するまで待機する。

**【フェーズ4: 動作検証とデバッグ】**
1.  **API仕様の確認:** ソースコード (`function_app.py`, `test_function_app.py`など) を読み、テスト対象のAPIエンドポイント（例: `/api/translate_function`）、HTTPメソッド（例: `POST`）、必須リクエストボディ（例: `{'text': '...'}`）を正確に把握する。
2.  **疎通確認 (curl):** フェーズ1で取得したホスト名と、フェーズ4-1で確認したAPI仕様を組み合わせて、`curl`コマンドを作成し、実行する。
3.  **ログの確認:** 疎通確認で問題が発生した場合、**この段階で初めて** `az webapp log tail` コマンドを実行し、リアルタイムログからエラーの原因を調査する。

---
